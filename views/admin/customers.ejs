 
<%- include("../../views/partials/admin/header") %>

<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark">Customers</h2>
    
  </div>

  <!-- Search Bar -->
  <div class="card shadow-sm mb-4">
    <div class="card-body p-3">
      <form action="" method="" class="d-flex justify-content-center">
        <div class="input-group" style="max-width: 600px;">
          <input 
            type="text" 
            class="form-control border-end-0" 
            placeholder="Search customers..." 
            name="search" 
            value="<%= searchQuery || '' %>"
          >
          <button class="btn btn-outline-dark" type="submit">
            <i class="fas fa-search me-1"></i>Search
          </button>
          <% if (searchQuery) { %>
          <a href="/admin/users" class="btn btn-dark ms-2">Clear</a>
          <% } %>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 fs-6 fw-semibold">
          <thead class="bg-light">
            <tr>
              <th scope="col" class="px-4 py-3">Name</th>
              <th scope="col" class="px-4 py-3">Email</th>
              <th scope="col" class="px-4 py-3">Phone No</th>
              <th scope="col" class="px-4 py-3 text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <% for(let i=0; i<data.length; i++) { %>
            <tr class="<%= i % 2 === 0 ? 'bg-white' : 'bg-light' %>">
              <td class="px-4 py-3 text-capitalize"><%= data[i].name %></td>
              <td class="px-4 py-3"><%= data[i].email %></td>
              <td class="px-4 py-3"><%= data[i].phone %></td>
              <td class="px-4 py-3 text-center">
                <% if(data[i].isBlocked===false) { %>
                <button class="btn btn-dark block-btn" 
                        data-href="/admin/blockCustomer?id=<%= data[i]._id %>&page=<%= currentPage %>">
                  Block
                </button>
                <% } else { %>
                <button class="btn btn-outline-dark unblock-btn"
                        data-href="/admin/unblockCustomer?id=<%= data[i]._id %>&page=<%= currentPage %>">
                  Unblock
                </button>
                <% } %>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="mt-4 d-flex justify-content-center">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link text-dark" href="?page=<%= currentPage-1 %><%= searchQuery ? `&search=${searchQuery}` : '' %>">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>
        <% } %>
        
        <% for(let i=1; i <= totalPages; i++) { %>
        <li class="page-item <%= (i === currentPage) ? 'active' : '' %>">
          <a class="page-link <%= (i === currentPage) ? 'bg-dark border-dark' : 'text-dark' %>" 
             href="?page=<%= i %><%= searchQuery ? `&search=${searchQuery}` : '' %>">
            <%= i %>
          </a>
        </li>
        <% } %>
        
        <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link text-dark" href="?page=<%= currentPage+1 %><%= searchQuery ? `&search=${searchQuery}` : '' %>">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
        <% } %>
      </ul>
    </nav>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://kit.fontawesome.com/16d4885483.js" crossorigin="anonymous"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.block-btn, .unblock-btn').forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = button.dataset.href;
        const isBlockAction = button.classList.contains('block-btn');

        const result = await Swal.fire({
          title: `Are you sure you want to ${isBlockAction ? 'block' : 'unblock'} this user?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#212529',
          cancelButtonColor: '#6c757d',
          confirmButtonText: `Yes, ${isBlockAction ? 'Block' : 'Unblock'}`,
          cancelButtonText: 'Cancel'
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch(url, { method: 'GET' });
            const data = await response.json();

            if (data.success) {
              button.textContent = isBlockAction ? 'Unblock' : 'Block';
              button.classList.toggle('btn-dark');
              button.classList.toggle('btn-outline-dark');
              button.classList.toggle('block-btn');
              button.classList.toggle('unblock-btn');

              const updatedUrl = isBlockAction
                ? `/admin/unblockCustomer?id=${data.id}&page=${data.page}`
                : `/admin/blockCustomer?id=${data.id}&page=${data.page}`;
              button.setAttribute('data-href', updatedUrl);

              Swal.fire({
                title: 'Success',
                text: data.message,
                icon: 'success',
                confirmButtonColor: '#212529'
              });
            } else {
              Swal.fire({
                title: 'Error',
                text: data.message,
                icon: 'error',
                confirmButtonColor: '#212529'
              });
            }
          } catch (error) {
            Swal.fire({
              title: 'Error',
              text: 'Something went wrong',
              icon: 'error',
              confirmButtonColor: '#212529'
            });
          }
        }
      });
    });
  });
</script>

<%- include("../../views/partials/admin/footer") %>
  